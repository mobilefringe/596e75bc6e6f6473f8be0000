<html>
<head>
    <title>API Example</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,400italic,600,600italic,700,700italic,300italic" rel="stylesheet" type="text/css">
    <link href="chat.css" rel="stylesheet" />
    <link href="animate.css" rel="stylesheet" />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script type="text/javascript">
        var accessToken = '6815bff4f00341e0a5f0b6e2459340c7';  //Replace access token here
        var baseUrl = "http://mallmaverickdevelopment.com/";
        
        $(document).ready(function() {
            // Send "welcome" message upon opening Chatbot so the custom welcome message will be displayed.
            axios.post('http://localhost:9000/chatbot_endpoint', {
                message: "welcome",
                property_id: 98 //Set the property ID
            })
            .then(function (response) {
                setTimeout(function() {
                    setResponse(JSON.stringify(response, undefined, 2));
                }, 1500);
                prompt();
            })
            .catch(function (error) {
                console.log(error);
            });

            $("#input").keypress(function(event) {
                if (event.which == 13) {
                    event.preventDefault();
                    send();
                }
            });
            
            $(".close_chatbot").click(function() {
                $("#chat_modal").remove();    
            });
        });
        
        function prompt(){
            console.log("Hello!")
        }
        
        function send() {
            var text = $("#input").val();
            var d = document.getElementById('bot').innerHTML;
            document.getElementById('bot').innerHTML = d.replace(' animated flipInX', '') + "<div class='calloutbig'><div class='calloutleft'>" + text + "</div><div class='message-from message-from-me'>" + moment().format('MMMM D, YYYY | h:mmA'); + "</div></div>";
            
            axios.post('http://localhost:9000/chatbot_endpoint', {
                message: text,
                property_id: 98 //Set the property ID
            })
            .then(function (response) {

                $("<div class='calloutbig typing'><img src='//codecloud.cdn.speedyrails.net/sites/596e75bc6e6f6473f8be0000/image/gif/1502381728000/typing.gif'></div>").appendTo(document.getElementById('bot'));
                
                var objDiv = document.getElementById("bot");
                objDiv.scrollTop = objDiv.scrollHeight;
            
                setTimeout(function() {
                    setResponse(JSON.stringify(response, undefined, 2));
                }, 1500);
            })
            .catch(function (error) {
                console.log(error);
            });
            
            $('#input').val("");
            
            var d = document.getElementById('bot').lastElementChild.innerHTML;
            document.getElementById('bot').lastElementChild.innerHTML = [d.slice(0, 23), " animated flipInX", d.slice(23)].join('');
            
            var objDiv = document.getElementById("bot");
            objDiv.scrollTop = objDiv.scrollHeight;
        }

        function setResponse(val) {
            $(".typing").remove();
             
            $("#response").text(val);
            speech = $.parseJSON(val);
            var d = document.getElementById('bot').innerHTML;

            document.getElementById('bot').innerHTML = d.replace(' animated flipInX', '') + "<div class='calloutbig'><img src='//codecloud.cdn.speedyrails.net/sites/596e75bc6e6f6473f8be0000/image/png/1501600070000/Mall-Icon_Default2.png' width='45px' height='45px' class='circular--square' style='float: left;' /><div class='calloutright'>" + speech.data + "</div><div class='message-from message-from-bot'>" + moment().format('MMMM D, YYYY | h:mmA'); + "</div></div>";

            var d = document.getElementById('bot').lastElementChild.innerHTML;
            document.getElementById('bot').lastElementChild.innerHTML = [d.slice(0, 218), " animated flipInX", d.slice(218)].join('');
            
            var objDiv = document.getElementById("bot");
            objDiv.scrollTop = objDiv.scrollHeight;
        }
    </script>

</head>
<body >
    <div class="panel">
        <div class="header">
            <div class="toolbar">
                <span md-truncate flex>Mall Assistant</span>
            </div>
            <span flex></span>
        </div>
        <div id="bot" class="botclass"></div>
        <div class='console'>
            <input id="input" type="text" class="textin" autofocus>
        </div>
    </div>
</body>
</html>
